<?php
require_once 'info.php';
class User {
    private $first_name,$last_name,$email,$phone,$pass,$birthday,$gender,$online_time;
    public $wmsg = 0;
    
    //gets info of user with email or phone and password
    function getUser($user, $pass) {
        $this->wmsg = 0;
        if(preg_match("/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,})$/i", $user))
            $result = queryMysql("SELECT * FROM members WHERE email='$user' AND pass='$pass'");
        else if(preg_match("/^[1-9][0-9]{9,10}$/", $user))
            $result = queryMysql("SELECT * FROM members WHERE phone='$user' AND pass='$pass'");
        else {
            $this->wmsg = 3; //Invalid phone or email error
            return;
        }
        if($result->num_rows == 1) {
            $row = $result->fetch_assoc();
            $this->first_name = $row['first_name'];
            $this->last_name = $row['last_name'];
            $this->email = $row['email'];
            $this->phone = $row['phone'];
            $this->pass = $row['pass'];
            $this->birthday = $row['birthday'];
            $this->gender = $row['gender'];
            $this->online_time = $row['online_time'];
        }
        else {
            $this->wmsg = 2; //User not exist error
        }
    }
    
    //create user
    function createUser($user, $pass, $first_name, $last_name, $birthday, $gender) {
        $this->wmsg = 0;
        $user = sanitizeString($user);
        $pass = sanitizeString($pass);
        $first_name = sanitizeString($first_name);
        $last_name = sanitizeString($last_name);
        $birthday = sanitizeString($birthday);
        $gender = sanitizeString($gender);
        $email = "";
        $phone = "";
        if(preg_match("/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,})$/i", $user)) 
            $email = $user;
        else if(preg_match("/^[1-9][0-9]{9,10}$/", $user))
            $phone = $user;
        else {
            $this->wmsg = 4; //invalid email or phone
            return;
        }
        $time = time();
        $query = queryMysql("SELECT * FROM members where email = '$email' and phone = '$phone'");
        if(!$query->num_rows) {
            $result = queryMysql("INSERT INTO members VALUES('$first_name', '$last_name', '$email', '$phone', '$pass', '$birthday', '$gender', '$time', NULL)");
            $this->first_name = $first_name;
            $this->last_name = $last_name;
            $this->birthday = $birthday;
            $this->email = $email;
            $this->phone = $phone;
            $this->pass = $pass;
            $this->gender = $gender;
            $this->online_time = $time;
        }
        else 
            $this->wmsg = 1; //User already exist error
    }
    
    //display all data
    function showUser() {
        if(isset($this->email))
            echo "$this->first_name, $this->last_name, $this->email, $this->phone, $this->pass, $this->birthday, $this->gender, $this->online_time";
        else 
            echo "Nothing to display";
    }
    
    function getFirstName() {
        return $this->first_name;
    }
    
    function getLastName() {
        return $this->last_name;
    }
    
    function getEmail() {
        return $this->email;
    }
    
    function getPhone() {
        return $this->phone;
    }
    
    function getBirthday() {
        return $this->birthday;
    }
    
    function getOnlineTime() {
        
    }
    
    function showError() {
        if($this->wmsg == 0)
            echo "No error";
        else if($this->wmsg == 1)
            echo "User Already Exist";
        else if($this->wmsg == 2)
            echo "User Not Exist";
        else if($this->wmsg == 3)
            echo "Invalid Email or Phone in getting user";
        else if($this->wmsg == 4)
            echo "Invalid Email or Phone in creating user";
    }
}


$test = new User();
$test->getUser('vishalchiluveri@gmail.com', '6nw3aals')
if(!$test->wmsg)
    $test->showUser();
else die($test->showError());
?>